name: Generate Pacman graph and update README

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate pacman-contribution-graph.svg
        uses: abozanona/pacman-contribution-graph@main
        with:
          github_user_name: ${{ github.repository_owner }}

      - name: Move generated SVG and update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          # Ensure output exists
          if [ ! -f dist/pacman-contribution-graph.svg ]; then
            echo "Generated SVG not found at dist/pacman-contribution-graph.svg"
            exit 1
          fi

          mkdir -p images
          cp -f dist/pacman-contribution-graph.svg images/pacman-contribution-graph.svg

          # Prepend the image to README if not present
          if ! grep -q "pacman-contribution-graph.svg" README.md; then
            echo "Adding pacman contribution graph to README.md"
            echo "" >> README.md
            echo "![Pacman contribution graph](images/pacman-contribution-graph.svg)" | cat - README.md > README.new
              fi
              git add images/pacman-contribution-graph.svg README.md || true
              if git diff --staged --quiet; then
              echo "No changes to commit"
              else
              git commit -m "chore: update pacman contribution graph"
              git push origin HEAD
              fi
                    # Check for changes to commit
                    if git diff --staged --quiet; then
                        echo "No changes to commit"
                    else
                        git commit -m "chore: update pacman contribution graph"
                        git push origin HEAD
                    fi